{% extends 'diagram_app/base.html' %}

{% block title %}Mermaid Code Editor{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/codemirror.min.css">
<style>
    .editor-container {
        display: flex;
        gap: 1rem;
        padding: 1rem;
        height: calc(100vh - 80px);
    }
    .editor-section, .preview-section {
        flex: 1;
        display: flex;
        flex-direction: column;
    }
    .editor-header, .preview-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }
    .CodeMirror {
        height: 100% !important;
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 8px;
    }
    .editor-controls {
        display: flex;
        gap: 0.5rem;
    }
    .control-button {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 6px;
        padding: 0.5rem 1rem;
        color: #fff;
        cursor: pointer;
    }
    .control-button:hover {
        background: rgba(79, 195, 247, 0.1);
        border-color: #4fc3f7;
    }
    .preview-container {
        flex: 1;
        background: rgba(255, 255, 255, 0.02);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        padding: 1rem;
        overflow: auto;
    }
    @media (max-width: 768px) {
        .editor-container {
            flex-direction: column;
            height: auto;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="editor-container">
    <div class="editor-section">
        <div class="editor-header">
            <h3>Mermaid Code Editor</h3>
            <div class="editor-controls">
                <button class="control-button" onclick="renderDiagram()">Render</button>
                <button class="control-button" onclick="downloadDiagram('png')">PNG</button>
                <button class="control-button" onclick="downloadDiagram('svg')">SVG</button>
                <button class="control-button" onclick="copyCode()">Copy</button>
                <button class="control-button" onclick="saveDiagram()">Save</button>
            </div>
        </div>
        <textarea id="codeEditor">[MERMAID_START]
flowchart TD
    A[Start] --> B[Process]
    B --> C[End]
[MERMAID_END]</textarea>
    </div>
    <div class="preview-section">
        <div class="preview-header">
            <h3>Live Preview</h3>
        </div>
        <div class="preview-container" id="previewContainer">
            <div class="preview-empty">
                <i class="fas fa-diagram-project"></i>
                <p>Start typing Mermaid code to see the magic happen!</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/javascript/javascript.min.js"></script>
<script>
const editor = CodeMirror.fromTextArea(document.getElementById('codeEditor'), {
    mode: 'javascript',
    theme: 'monokai',
    lineNumbers: true,
    autoCloseBrackets: true
});
editor.setSize('100%', '100%');

async function renderDiagram() {
    const code = editor.getValue();
    const previewContainer = document.getElementById('previewContainer');
    previewContainer.innerHTML = '';
    try {
        const diagramId = `diagram-${Date.now()}`;
        const { svg } = await mermaid.render(diagramId, code);
        previewContainer.innerHTML = svg;
        const svgElement = previewContainer.querySelector('svg');
        if (svgElement) {
            svgElement.style.maxWidth = '100%';
            svgElement.style.height = 'auto';
        }
    } catch (error) {
        previewContainer.innerHTML = `<div class="text-danger">Rendering error: ${error.message}</div>`;
    }
}

async function downloadDiagram(format) {
    const code = editor.getValue();
    try {
        const response = await fetch('{% url "diagram_app:export_diagram" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ mermaid_code: code, format })
        });
        if (!response.ok) throw new Error('Failed to export diagram');
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `diagram.${format}`;
        a.click();
        window.URL.revokeObjectURL(url);
    } catch (error) {
        alert(`Export error: ${error.message}`);
    }
}

async function copyCode() {
    try {
        await navigator.clipboard.writeText(editor.getValue());
        alert('Code copied to clipboard!');
    } catch (error) {
        alert('Failed to copy code');
    }
}

async function saveDiagram() {
    const code = editor.getValue();
    try {
        const response = await fetch('{% url "diagram_app:save_diagram_edit" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ mermaid_code: code, title: 'Edited Diagram' })
        });
        const data = await response.json();
        if (data.success) {
            alert(data.message);
        } else {
            alert(`Save error: ${data.error}`);
        }
    } catch (error) {
        alert(`Save error: ${error.message}`);
    }
}

// Initial Render
renderDiagram();
editor.on('change', renderDiagram);
{% endblock %}