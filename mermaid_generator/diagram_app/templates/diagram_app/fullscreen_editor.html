<!DOCTYPE html>
<html>
<head>
    <title>Mermaid Editor</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { margin: 0; height: 100vh; }
        .container-fluid { height: 100vh; }
        .editor-panel { height: 100vh; }
        textarea { height: 80vh; font-family: monospace; }
        .preview-panel { height: 100vh; overflow: auto; background: #f8f9fa; }
        .diagram-container { padding: 20px; }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row h-100">
            <!-- Code Editor -->
            <div class="col-6 editor-panel">
                <div class="p-3">
                    <h5>Mermaid Code</h5>
                    <div class="mb-2">
                        <button class="btn btn-primary btn-sm" onclick="renderDiagram()">Render</button>
                        <button class="btn btn-success btn-sm" onclick="downloadPNG()">Download PNG</button>
                        <button class="btn btn-info btn-sm" onclick="downloadSVG()">Download SVG</button>
                        <button class="btn btn-secondary btn-sm" onclick="copyCode()">Copy</button>
                    </div>
                    <textarea id="codeEditor" class="form-control" placeholder="Enter your Mermaid code here..."></textarea>
                </div>
            </div>
            
            <!-- Preview -->
            <div class="col-6 preview-panel">
                <div class="p-3">
                    <h5>Preview</h5>
                    <div class="diagram-container">
                        <div id="diagramPreview"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script>
        // Load code from localStorage if available
        const savedCode = localStorage.getItem('mermaidCode');
        if (savedCode) {
            document.getElementById('codeEditor').value = savedCode;
            localStorage.removeItem('mermaidCode'); // Clean up
            renderDiagram();
        } else {
            // Default code
            document.getElementById('codeEditor').value = `flowchart TD
    A[Start] --> B{Decision}
    B -->|Yes| C[Process]
    B -->|No| D[End]
    C --> D`;
            renderDiagram();
        }

        mermaid.initialize({ startOnLoad: false, theme: 'default', securityLevel: 'loose' });

        async function renderDiagram() {
            const code = document.getElementById('codeEditor').value;
            const preview = document.getElementById('diagramPreview');
            
            if (!code.trim()) {
                preview.innerHTML = '<p class="text-muted">Enter code to see preview</p>';
                return;
            }
            
            try {
                preview.innerHTML = '';
                const diagramId = 'diagram-' + Date.now();
                const { svg } = await mermaid.render(diagramId, code);
                preview.innerHTML = svg;
            } catch (error) {
                preview.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
            }
        }

        async function downloadPNG() {
            const diagramElement = document.getElementById('diagramPreview');
            try {
                const canvas = await html2canvas(diagramElement, { backgroundColor: '#ffffff' });
                const link = document.createElement('a');
                link.download = 'diagram.png';
                link.href = canvas.toDataURL();
                link.click();
            } catch (error) {
                alert('Error generating PNG: ' + error.message);
            }
        }

        function downloadSVG() {
            const svg = document.querySelector('#diagramPreview svg');
            if (!svg) {
                alert('No diagram to download');
                return;
            }
            
            const svgData = new XMLSerializer().serializeToString(svg);
            const blob = new Blob([svgData], {type: 'image/svg+xml'});
            const url = URL.createObjectURL(blob);
            
            const link = document.createElement('a');
            link.download = 'diagram.svg';
            link.href = url;
            link.click();
            
            URL.revokeObjectURL(url);
        }

        function copyCode() {
            const code = document.getElementById('codeEditor').value;
            navigator.clipboard.writeText(code).then(() => {
                alert('Code copied to clipboard!');
            });
        }

        // Auto-render on typing (with delay)
        let timeout;
        document.getElementById('codeEditor').addEventListener('input', function() {
            clearTimeout(timeout);
            timeout = setTimeout(renderDiagram, 1000);
        });
    </script>
</body>
</html>
